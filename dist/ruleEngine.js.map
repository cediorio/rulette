{"version":3,"sources":["../src/ruleEngine.js"],"names":["sandbox","vm","createContext","Fact","fact","id","kb_type","name","parseNames","trim","value","validValues","displayQuestion","factDescription","prototype","Rule","rule","result","lhs","parseRule","conditions","rhs","trueDisplayValue","falseDisplayValue","topic","source","notes","replace","createKB","facts_range","rules_range","facts","i","length","push","rules","forEach","buildFactEvalStr","evalStr","toLowerCase","join","fire","kb","setAgenda","ruleResultsJSON","openFacts","closedFacts","factEvalStr","resultText","lhs_facts","tokenize","ruleEvalStr","runInContext","map","getFactStatus","support_description","functionNames","filter","e","evalF","val","rule_match","s","tokens","split","token_map","token","agenda","inAgenda","indexOf","unshift","printAgenda"],"mappings":"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","sourcesContent":["import vm from \"vm-browserify\";\n\nvar sandbox = vm.createContext({});\n\n/** Define classes for RuleBase **/\nfunction Fact(fact) {\n  this.id = fact.kb_type + fact.id;\n  this.name = this.parseNames(fact.name).trim();\n  this.value = fact.value;\n  this.validValues = fact.validValues;\n  this.displayQuestion = fact.displayQuestion;\n  this.factDescription = fact.factDescription;\n}\n\nFact.prototype.parseNames = function(name) {\n  // name = name.replace( /(\\w)-(\\w)/g, \"\\1_\\2\" );  // we don't need to do this, just make sure fact and rule names match!\n\n  return name;\n};\n\nfunction Rule(rule) {\n  this.name = rule.result;\n  this.lhs = this.parseRule(this.parseNames(rule.conditions));\n  this.rhs = rule.result;\n  this.value = null;\n  this.trueDisplayValue = rule.trueDisplayValue;\n  this.falseDisplayValue = rule.falseDisplayValue;\n  this.topic = rule.topic;\n  this.source = rule.source;\n  this.notes = rule.notes;\n}\n\nRule.prototype.parseNames = function(name) {\n  return name;\n};\n\nRule.prototype.parseRule = function(rule) {\n  if (rule === true) return rule;\n  rule = rule.replace(/\\s+and\\s+/g, \" && \");\n  rule = rule.replace(/\\s+or\\s+/g, \" || \");\n  rule = rule.replace(/\\s*not\\s+/g, \" !\");\n\n  return rule;\n};\n\nfunction createKB(facts_range = [], rules_range = []) {\n  /* takes a fact object and rules object\n\t   and returns a kb object\n\t*/\n\n  var facts = [];\n\n  for (let i = 0; i < facts_range.length; i++) {\n    facts.push(new Fact(facts_range[i]));\n  }\n\n  var rules = [];\n  rules_range.forEach(function(rule) {\n    if (rule.conditions !== \"\") rules.push(new Rule(rule));\n  });\n\n  return {\n    facts,\n    rules\n  };\n}\n\nfunction buildFactEvalStr(facts) {\n  var evalStr = [];\n  for (let i = 0; i < facts.length; i++) {\n    // facts[i].name = parseNames(facts[i].name); // clean the syntax if necessary\n    if (facts[i].name === \"\") continue; // skip if there is no fact on this line\n    if (facts[i].value === \"UNKNOWN\") facts[i].value = null;\n    evalStr.push(\n      \"var \" + facts[i].name + \" = \" + facts[i].value.toLowerCase() + \";\"\n    ); // otherwise build the string for eval\n  }\n  return evalStr.join(\"\\n\") + \"\\n\\n\";\n}\n\nfunction fire(kb) {\n  //set up a sandbox context for evaluation\n\n  var rules = setAgenda(kb.rules);\n  var facts = kb.facts;\n  var ruleResultsJSON = []; // full report on results of Rule evaluation\n  var openFacts = []; // Facts which have no answers yet\n  var closedFacts = []; // Facts which have been answered\n  var factEvalStr = buildFactEvalStr(facts);\n  // evaluate the rules\n  for (let i = 0; i < rules.length; i++) {\n    let resultText = \"\";\n    if (rules[i].lhs === \"\") continue; // skip if there is no rule on this line\n    let lhs_facts = tokenize(rules[i].lhs);\n    let ruleEvalStr = rules[i].lhs;\n    let result = vm.runInContext(factEvalStr + \"\\n\" + ruleEvalStr, sandbox);\n\n    if (result) {\n      resultText = rules[i].trueDisplayValue;\n      vm.runInContext(\"var \" + rules[i].rhs + \" = true;\", sandbox); // assert the right-hand of the rule\n      rules[i].value = true;\n    } else {\n      resultText = rules[i].falseDisplayValue;\n      vm.runInContext(\"var \" + rules[i].rhs + \" = false;\", sandbox); // deny the right-hand of the rule\n      rules[i].value = false;\n    }\n    // console.log('this topic is: ' + rules[i].topic);\n    ruleResultsJSON.push({\n      name: rules[i].name,\n      lhs: rules[i].lhs,\n      rhs: rules[i].rhs,\n      value: rules[i].value,\n      topic: rules[i].topic,\n      source: rules[i].source,\n      result: resultText,\n      facts: lhs_facts.map(function(i) {\n        var fact = getFactStatus(i, kb);\n        // var support_desc = !!fact.factDescription ? fact.factDescription : \"No further support provided\";\n        return {\n          name: fact.name,\n          value: fact.value,\n          support_description: fact.factDescription\n        };\n      })\n    });\n  }\n  // console.log(resultsJSON);\n  return {\n    ruleResultsJSON,\n    openFacts,\n    closedFacts\n  };\n}\n\nfunction getFactStatus(i, kb) {\n  var facts = kb.facts;\n  var rules = kb.rules;\n  // console.log(\"this fact is: \" + i);\n  // this is a list of stopwords that are utility function names in this module\n  // if the \"fact\" is a function, we'll eval it and return the fact status\n  var functionNames = [\"getYear\", \"getMonth\"];\n  if (\n    functionNames.filter(function(e) {\n      return e === i;\n    }).length > 0\n  ) {\n    var evalF = i + \"()\";\n    var val = vm.runInContext(evalF, sandbox);\n    return {\n      name: i,\n      value: val,\n      support_description: \"Utility function evaluation\"\n    };\n  }\n  var fact = facts.filter(function(e) {\n    return e.name === i;\n  })[0];\n  // if the condition wasn't in facts, then it must be in rules\n  if (typeof fact === \"undefined\") {\n    var rule_match = rules.filter(function(e) {\n      return e.name === i;\n    })[0];\n    return {\n      name: rule_match.name,\n      value: rule_match.value,\n      support_description: \"Rule evaluation\"\n    };\n  }\n  return fact;\n}\n\nfunction tokenize(s) {\n  if (s === true) return s;\n  var tokens = s.split(/[^\\b\\w\\b]|\\b\\d\\b/g);\n  var token_map = tokens.map(function(i) {\n    var token = i.trim();\n    return token;\n  });\n  // return token_map;\n  return token_map.filter(function(e) {\n    return e.length > 0;\n  });\n}\n\nfunction setAgenda(rules) {\n  var agenda = [];\n  // get all the rule names\n  // var rule_names = rules.map(function(rule) {\n  //   return rule.name;\n  // });\n\n  rules.forEach(function(rule) {\n    var inAgenda = false; // flag to mark presence of rule in agenda\n    for (let i = 0; i < agenda.length; i++) {\n      // tokenize each lhs and check to see if the current rule.rhs is in it\n      var tokens = tokenize(agenda[i].lhs);\n      // if it is in the agenda, put it at the front of the agenda and bail\n      if (tokens.indexOf(rule.rhs) > -1) {\n        inAgenda = true;\n        agenda.unshift(rule);\n        break;\n      }\n    }\n    // if the previous for loop didn't find the current rule.rhs in the agenda,\n    // push it onto the end of the agenda\n    if (!inAgenda) agenda.push(rule);\n  });\n\n  return agenda;\n}\n\nfunction printAgenda(agenda) {\n  return agenda\n    .map(function(i) {\n      return \"LHS: \" + i.lhs + \" RHS: \" + i.rhs;\n    })\n    .join(\" \\n\");\n}\n\n// function getYear() {\n//   var d = new Date();\n//   return d.getFullYear();\n// }\n\n// function getMonth() {\n//   var d = new Date();\n//   return d.getMonth();\n// }\n\nexport default { fire, createKB, printAgenda };\n"],"file":"ruleEngine.js"}